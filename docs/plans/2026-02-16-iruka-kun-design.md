# iruka-kun 設計ドキュメント

**作成日:** 2026-02-16
**ステータス:** 承認待ち

---

## 1. プロダクト概要

macOS上に常駐するデスクトップキャラクターアプリ。ドット絵のイルカが画面上に表示され、時間帯や操作に応じてセリフを吹き出しで表示したり、アニメーションで感情を表現する。Windowsの「カイルくん（Office アシスタント）」のmacOS版をイメージした癒し系常駐アプリ。

---

## 2. 決定事項

### 2.1 表示・ウィンドウ

| 項目 | 決定内容 |
|------|----------|
| 表示方式 | フローティングウィンドウ（背景透過NSWindow） |
| ウィンドウレベル | 常に最前面（`NSWindow.Level.floating` 以上） |
| マウス透過 | 透明部分はクリックスルー（`NSView.hitTest` オーバーライド）。吹き出し表示中は吹き出し領域もクリック可 |
| 初期位置 | 画面右下付近 |
| 移動 | ユーザーがドラッグで任意の位置に配置可能。位置を永続化 |
| マルチディスプレイ | ドラッグした画面に表示。最後の位置を記憶 |

### 2.2 キャラクター・アニメーション

| 項目 | 決定内容 |
|------|----------|
| アート | ドット絵（ピクセルアート） |
| 表示サイズ | 96x96px程度（Retina対応で実アセットは192x192px @2x） |
| アニメーション方式 | スプライトアニメーション（フレーム画像切り替え） |
| 状態数 | 5種類（下記参照） |

#### 状態一覧とトリガー

| 状態 | アニメーション | トリガー |
|------|--------------|----------|
| **アイドル** | ゆらゆら泳ぐ | デフォルト状態 |
| **喜ぶ** | 跳ねる / キラキラ | ユーザーがクリック |
| **寝る** | 目を閉じてゆっくり浮遊 | 深夜帯（例: 0:00〜6:00） |
| **驚く** | ビクッとする | ユーザーがドラッグ開始 |
| **退屈** | あくび / ぼんやり | 長時間操作なし（例: 30分以上） |

### 2.3 セリフ・吹き出し

| 項目 | 決定内容 |
|------|----------|
| 吹き出し方向 | キャラクター近傍（上または横） |
| 消え方 | 3〜5秒で自動フェードアウト |
| 入力 | MVPでは入力なし（出力のみ） |
| 出現頻度 | 10〜20分に1回（時間帯ベース） |
| トリガー | 時間帯ベース + 操作リアクション |

#### セリフカテゴリ（MVP）

| カテゴリ | 例 |
|----------|-----|
| 朝の挨拶（6:00〜10:00） | 「おはよう！今日もがんばろう」 |
| 昼（10:00〜18:00） | 「いい天気だね〜」「休憩した？」 |
| 夜（18:00〜24:00） | 「おつかれさま」「そろそろ休む？」 |
| 深夜（0:00〜6:00） | 「zzz...」（寝る状態と連動） |
| クリック反応 | 「なあに？」「キュッ！」 |
| ドラッグ反応 | 「わわっ！」「どこ連れてくの？」 |
| 放置反応 | 「ひまだな〜」「遊んでよ〜」 |

### 2.4 常駐・ライフサイクル

| 項目 | 決定内容 |
|------|----------|
| Dock表示 | 非表示（`LSUIElement = YES`） |
| メニューバー | アイコン常駐 |
| ログイン時自動起動 | 設定でON/OFF（`SMAppService` / Login Items） |
| 終了方法 | メニューバーから「終了」 |

### 2.5 メニューバー機能

| メニュー項目 | 動作 |
|-------------|------|
| イルカを表示 / 非表示 | キャラクターウィンドウのトグル |
| 状態 | 現在の状態（アイドル/寝てる等）を表示（読み取り専用） |
| 設定... | 設定ウィンドウを開く |
| iruka-kun について | Aboutパネル |
| 終了 | アプリを終了 |

### 2.6 設定項目（MVP）

| 設定 | 内容 |
|------|------|
| ログイン時に自動起動 | ON/OFF トグル |

### 2.7 サウンド

| 項目 | 決定内容 |
|------|----------|
| クリック時 | 短い効果音（「キュッ」等） |
| その他 | 無音 |
| 音量 | システム効果音の音量に従う（`NSSound` / `AVAudioPlayer`） |

### 2.8 対象環境

| 項目 | 決定内容 |
|------|----------|
| 最低OS | macOS 15 (Sequoia) |
| アーキテクチャ | Universal Binary（Apple Silicon + Intel） |
| 配布 | 初期は直接配布（.dmg + Developer ID署名 + 公証）、安定後App Store検討 |

---

## 3. アーキテクチャ

### 3.1 方針

**AppKit主体 + SwiftUI設定画面** のハイブリッド構成。

```
iruka-kun/
├── App/
│   ├── AppDelegate.swift          # アプリライフサイクル、メニューバー管理
│   └── IrukaApp.swift             # エントリポイント
├── Character/
│   ├── CharacterWindow.swift      # 透過NSWindow
│   ├── CharacterView.swift        # NSView: スプライト描画 + ヒットテスト
│   ├── SpriteAnimator.swift       # フレームアニメーション制御
│   └── BubbleView.swift           # 吹き出し表示（NSView or SwiftUI）
├── State/
│   ├── CharacterState.swift       # 状態定義（enum）
│   ├── StateMachine.swift         # 状態遷移ロジック
│   └── DialogueManager.swift      # セリフ選択・スケジュール管理
├── MenuBar/
│   ├── StatusBarController.swift  # NSStatusItem管理
│   └── MenuBarMenu.swift          # メニュー構築
├── Settings/
│   └── SettingsView.swift         # SwiftUI設定画面
├── Resources/
│   ├── Sprites/                   # スプライトシート（状態ごと）
│   ├── Sounds/                    # 効果音ファイル
│   └── Dialogues.json             # セリフデータ
└── Utilities/
    ├── PositionStore.swift        # ウィンドウ位置の永続化（UserDefaults）
    └── ScreenUtility.swift        # マルチディスプレイ対応ユーティリティ
```

### 3.2 主要コンポーネント

#### CharacterWindow（透過ウィンドウ）
- `NSWindow` サブクラス
- `backgroundColor = .clear`, `isOpaque = false`
- `styleMask = .borderless`
- `level = .floating`（常に最前面）
- `ignoresMouseEvents = false`（ヒットテストで制御）
- `collectionBehavior` にて Spaces / フルスクリーン挙動を制御

#### CharacterView（スプライト描画）
- `NSView` サブクラス
- `hitTest(_:)` をオーバーライドし、透明ピクセルでは `nil` を返す（クリックスルー実現）
- `CALayer` ベースでスプライトフレームを表示
- 吹き出し表示時は吹き出し領域もヒット対象に含める

#### SpriteAnimator（アニメーション制御）
- 各状態ごとのスプライトシート（フレーム配列）を管理
- `CADisplayLink` または `Timer` でフレーム送り
- 状態遷移時にアニメーションをクロスフェードまたは即時切替

#### StateMachine（状態管理）
- `CharacterState` enum: `.idle`, `.happy`, `.sleeping`, `.surprised`, `.bored`
- トリガーイベント（クリック、ドラッグ、時間帯変化、放置タイマー）を受け取り状態を遷移
- 状態変更を `SpriteAnimator` と `DialogueManager` に通知

#### DialogueManager（セリフ管理）
- `Dialogues.json` からセリフデータを読み込み
- 時間帯・状態に応じたセリフをランダム選択
- 10〜20分間隔のタイマーで自動発話
- 操作トリガー（クリック/ドラッグ）での即時発話

---

## 4. MVP範囲

### MVP に含めるもの
- [x] 透過フローティングウィンドウでのイルカ表示
- [x] 5状態のスプライトアニメーション（各状態3〜6フレーム程度）
- [x] ドラッグによる位置移動 + 位置記憶
- [x] 時間帯ベースのセリフ吹き出し（自動、10〜20分間隔）
- [x] 操作リアクション（クリック → 喜ぶ + セリフ、ドラッグ → 驚く + セリフ）
- [x] 放置検知 → 退屈状態
- [x] 吹き出し自動消滅（3〜5秒フェードアウト）
- [x] クリック時の効果音
- [x] メニューバー常駐（表示/非表示、状態表示、設定、終了）
- [x] 設定: ログイン時自動起動 ON/OFF
- [x] Dock非表示（LSUIElement）
- [x] マルチディスプレイ対応（ドラッグ移動 + 位置記憶）
- [x] 直接配布（.dmg + 署名 + 公証）

### MVP に含めないもの（将来スコープ）
- [ ] テキスト入力による会話機能
- [ ] LLM API連携（Claude API等）
- [ ] キャラクターサイズ変更設定
- [ ] セリフ頻度調整設定
- [ ] サウンドON/OFF設定
- [ ] 育成要素（好感度・パラメータ）
- [ ] 複数キャラクター選択
- [ ] App Store配布
- [ ] ユーザーによるセリフカスタマイズ

---

## 5. 未決事項

| # | 項目 | 論点 | 仮置き |
|---|------|------|--------|
| 1 | スプライトアニメーション展開 | 既存の `assets/iruka.png`（ドット絵）を基にした各状態のスプライトシート制作方法 | 基本ポーズは既存アセット、各状態のフレームバリエーションは別途制作が必要 |
| 2 | 効果音の素材 | フリー素材 / オリジナル制作 | フリー素材で仮実装 |
| 3 | セリフの量と質 | MVP時点で何セリフ用意するか | 各カテゴリ5〜10個、計30〜50個を想定 |
| 4 | 深夜帯の定義 | 何時〜何時を「深夜」とするか | 0:00〜6:00を仮置き |
| 5 | 退屈トリガーの閾値 | 何分操作なしで「退屈」になるか | 30分を仮置き |
| 6 | アプリアイコン | メニューバー・About用のアイコンデザイン | 未定 |
| 7 | アプリ名の正式表記 | 「iruka-kun」「イルカくん」等 | iruka-kun を仮置き |

---

## 6. リスク

| # | リスク | 影響 | 対策 |
|---|--------|------|------|
| 1 | **透明ピクセルのヒットテスト精度** | ドット絵の境界でクリックが期待通り動かない可能性 | アルファ閾値を調整可能にする。バウンディングボックスのフォールバックを用意 |
| 2 | **常に最前面がUX的に邪魔** | ユーザーの作業を遮る可能性 | メニューバーから即座に非表示にできるようにする。将来的に最前面トグルも検討 |
| 3 | **macOS セキュリティ制約** | 公証やサンドボックスで予期しない制限を受ける可能性 | 直接配布時はHardened Runtimeで対応。App Store検討時にサンドボックス対応を別途検証 |
| 4 | **スプライトアセットのリードタイム** | ドット絵の制作に時間がかかり開発が止まる | 仮アセット（プレースホルダー）で先に開発を進める |
| 5 | **バッテリー消費** | 常時アニメーションによるCPU/GPU使用 | アニメーションFPSを抑える（8〜12fps程度）。ウィンドウ非表示時はタイマー停止 |
| 6 | **マルチディスプレイのホットプラグ** | 外部ディスプレイを抜いた時にウィンドウが迷子になる | `NSScreen` の変更通知を監視し、メインディスプレイにフォールバック |

---

## 7. 非機能要件

| 項目 | 要件 |
|------|------|
| CPU使用率 | アイドル時 1% 以下を目標 |
| メモリ使用量 | 50MB 以下を目標 |
| アニメーションFPS | 8〜12fps（ドット絵アニメーションとして自然な範囲） |
| 起動時間 | 2秒以内にキャラクター表示 |
| 対応アーキテクチャ | Universal Binary（arm64 + x86_64） |
| 最低OS | macOS 15 (Sequoia) |
| アクセシビリティ | VoiceOverで「iruka-kunが表示中」程度の最低限の対応 |
| ローカライズ | MVPは日本語のみ。セリフデータは外部JSON化し、将来の多言語対応に備える |

---

## 8. 技術選定サマリ

| レイヤー | 技術 |
|----------|------|
| アプリライフサイクル | AppKit (`NSApplication`, `AppDelegate`) |
| キャラクターウィンドウ | AppKit (`NSWindow`, `NSView`) |
| スプライト描画 | Core Animation (`CALayer`) |
| 吹き出しUI | AppKit (`NSView`) or SwiftUI (embedded) |
| メニューバー | AppKit (`NSStatusItem`, `NSMenu`) |
| 設定画面 | SwiftUI (`Settings` scene or `NSHostingController`) |
| 永続化 | `UserDefaults`（位置、設定） |
| サウンド | `NSSound` or `AVAudioPlayer` |
| 自動起動 | `SMAppService`（macOS 13+） |
| 署名・配布 | Xcode + Developer ID + `notarytool` |

### 8.1 既存アセット

| ファイル | 用途 | 備考 |
|----------|------|------|
| `assets/iruka.png` | キャラクターの基本デザイン（ドット絵） | ジャンプポーズ。各状態のスプライトシートのベースとして使用 |
| `assets/iruka.svg` | メニューバーアイコン / Aboutパネル | ベクター形式。テンプレートイメージとしてメニューバーに使用可能 |
